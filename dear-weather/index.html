<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dear Weather | Premium Forecast</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
        }

        /* Ambient Background Animation */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: #0f172a;
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #4f46e5; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 400px; height: 400px; background: #06b6d4; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 300px; height: 300px; background: #8b5cf6; animation-delay: 4s; opacity: 0.4; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
        }

        /* Glass Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.05);
        }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 md:p-8">

    <div class="ambient-light">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <main class="w-full max-w-4xl z-10 space-y-6">
        
        <header class="space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-8 bg-cyan-400 rounded-full"></div>
                    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Dear Weather</h1>
                </div>
                
                <button id="unit-toggle-btn" class="glass-card px-4 py-2 rounded-full text-sm font-medium hover:bg-white/10 transition flex items-center gap-2">
                    <span id="unit-text">Metric (°C)</span>
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="relative group">
                <div class="flex gap-3">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 w-5 h-5"></i>
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search city..." 
                            class="glass-input w-full py-4 pl-12 pr-4 rounded-2xl text-lg placeholder-white/30"
                            autocomplete="off"
                        >
                        <div id="autocomplete-list" class="absolute top-full left-0 w-full mt-2 glass-card rounded-xl overflow-hidden hidden z-50"></div>
                    </div>
                    
                    <button id="gps-btn" class="glass-card p-4 rounded-2xl hover:bg-cyan-500/20 hover:border-cyan-500/50 transition group" title="Use My Location">
                        <i data-lucide="map-pin" class="w-6 h-6 text-white/80 group-hover:text-cyan-400"></i>
                    </button>
                </div>
            </div>

            <div id="favourites-container" class="flex flex-wrap gap-2 min-h-[2rem]">
                </div>
        </header>

        <div id="error-container" class="hidden p-4 rounded-xl bg-red-500/20 border border-red-500/30 text-red-200 text-center"></div>

        <div id="loading-indicator" class="hidden py-12 text-center">
            <div class="inline-block w-8 h-8 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-2 text-white/50 text-sm">Fetching forecast...</p>
        </div>

        <div id="weather-dashboard" class="hidden space-y-6 fade-in">
            
            <section class="glass-card rounded-3xl p-6 md:p-10 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-20">
                    <i data-lucide="cloud-sun" class="w-48 h-48"></i>
                </div>

                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h2 id="city-name" class="text-4xl md:text-5xl font-bold text-white">City Name</h2>
                            <button id="save-btn" class="text-white/40 hover:text-yellow-400 transition">
                                <i data-lucide="star" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <p id="weather-desc" class="text-lg text-cyan-200 capitalize">Clear Sky</p>
                        <div class="mt-6 flex items-center gap-4">
                            <span id="current-temp" class="text-7xl md:text-8xl font-bold tracking-tighter">24°</span>
                            <div class="flex flex-col justify-center h-full space-y-1 border-l border-white/10 pl-4">
                                <span id="max-min-temp" class="text-white/60">H: 28° L: 19°</span>
                                <span id="feels-like" class="text-white/60">Feels: 26°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white/5 rounded-2xl p-4 border border-white/5 backdrop-blur-sm">
                        <img id="weather-icon" src="" alt="Icon" class="w-24 h-24 drop-shadow-2xl filter saturate-150">
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-white/60 text-sm font-medium uppercase tracking-wider mb-3 px-1">Next 48 Hours</h3>
                <div id="hourly-container" class="flex gap-3 overflow-x-auto no-scrollbar pb-2 cursor-grab active:cursor-grabbing">
                    </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2 glass-card rounded-3xl p-6">
                    <h3 class="flex items-center gap-2 text-white/60 text-sm font-medium uppercase tracking-wider mb-6">
                        <i data-lucide="calendar" class="w-4 h-4"></i> 7-Day Forecast
                    </h3>
                    <div id="daily-container" class="space-y-1">
                        </div>
                </div>

                <div class="glass-card rounded-3xl p-6 flex flex-col gap-4">
                    <h3 class="flex items-center gap-2 text-white/60 text-sm font-medium uppercase tracking-wider mb-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Highlights
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 h-full">
                        <div class="bg-white/5 rounded-xl p-4 border border-white/5 flex flex-col justify-between">
                            <span class="text-white/50 text-xs">Wind</span>
                            <div class="flex items-end gap-1 mt-2">
                                <span id="wind-val" class="text-xl font-bold">0</span>
                                <span id="wind-unit" class="text-xs text-white/60 mb-1">km/h</span>
                            </div>
                            <i data-lucide="wind" class="w-5 h-5 text-cyan-300 self-end mt-1"></i>
                        </div>

                        <div class="bg-white/5 rounded-xl p-4 border border-white/5 flex flex-col justify-between">
                            <span class="text-white/50 text-xs">Humidity</span>
                            <div class="flex items-end gap-1 mt-2">
                                <span id="humidity-val" class="text-xl font-bold">0</span>
                                <span class="text-xs text-white/60 mb-1">%</span>
                            </div>
                            <i data-lucide="droplet" class="w-5 h-5 text-blue-400 self-end mt-1"></i>
                        </div>

                        <div class="bg-white/5 rounded-xl p-4 border border-white/5 flex flex-col justify-between">
                            <span class="text-white/50 text-xs">Visibility</span>
                            <div class="flex items-end gap-1 mt-2">
                                <span id="visibility-val" class="text-xl font-bold">0</span>
                                <span id="dist-unit" class="text-xs text-white/60 mb-1">km</span>
                            </div>
                            <i data-lucide="eye" class="w-5 h-5 text-purple-300 self-end mt-1"></i>
                        </div>

                        <div class="bg-white/5 rounded-xl p-4 border border-white/5 flex flex-col justify-between">
                            <span class="text-white/50 text-xs">Pressure</span>
                            <div class="flex items-end gap-1 mt-2">
                                <span id="pressure-val" class="text-xl font-bold">0</span>
                                <span class="text-xs text-white/60 mb-1">hPa</span>
                            </div>
                            <i data-lucide="gauge" class="w-5 h-5 text-emerald-300 self-end mt-1"></i>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-xl p-4 border border-white/5 mt-1">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-white/50 text-xs">Sun Cycle</span>
                            <i data-lucide="sun" class="w-4 h-4 text-yellow-400"></i>
                        </div>
                        <div class="flex justify-between items-end border-b border-white/10 pb-2 mb-2">
                            <span class="text-sm text-white/80">Sunrise</span>
                            <span id="sunrise-val" class="font-mono text-sm">00:00</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-sm text-white/80">Sunset</span>
                            <span id="sunset-val" class="font-mono text-sm">00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-12 py-6 text-center z-10">
        <p class="text-white/20 text-xs uppercase tracking-widest">Designed by Priyansh • Powered by OpenWeather</p>
    </footer>

    <script>
        // --- Icons Init ---
        lucide.createIcons();

        // --- State ---
        let currentUnit = 'metric'; // 'metric' or 'imperial'
        let favouriteCities = JSON.parse(localStorage.getItem('favouriteWeatherCities')) || [];
        let currentCity = 'Mumbai'; // Default
        let debounceTimeout;

        // --- Elements ---
        const searchInput = document.getElementById('search-input');
        const autocompleteList = document.getElementById('autocomplete-list');
        const weatherDashboard = document.getElementById('weather-dashboard');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorContainer = document.getElementById('error-container');
        const saveBtn = document.getElementById('save-btn');
        const unitToggleBtn = document.getElementById('unit-toggle-btn');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderFavourites();
            fetchWeather(currentCity);
        });

        // --- Event Listeners ---
        
        // 1. Search Input with Debounce
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(debounceTimeout);
            if (query.length < 3) {
                autocompleteList.classList.add('hidden');
                return;
            }
            debounceTimeout = setTimeout(() => fetchAutocomplete(query), 400);
        });

        // Search on Enter
        searchInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                fetchWeather(searchInput.value);
                autocompleteList.classList.add('hidden');
            }
        });

        // Close autocomplete on click outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        // 2. Unit Toggle
        unitToggleBtn.addEventListener('click', () => {
            currentUnit = currentUnit === 'metric' ? 'imperial' : 'metric';
            document.getElementById('unit-text').innerText = currentUnit === 'metric' ? 'Metric (°C)' : 'Imperial (°F)';
            fetchWeather(currentCity); // Refresh data
        });

        // 3. GPS Button
        document.getElementById('gps-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => fetchWeather(null, pos.coords.latitude, pos.coords.longitude),
                    () => showError("Location access denied.")
                );
            } else {
                showError("Geolocation not supported.");
            }
        });

        // 4. Save/Favourite
        saveBtn.addEventListener('click', () => {
            if (!currentCity) return;
            const index = favouriteCities.indexOf(currentCity);
            if (index > -1) {
                favouriteCities.splice(index, 1);
                saveBtn.innerHTML = '<i data-lucide="star" class="w-6 h-6"></i>';
            } else {
                favouriteCities.push(currentCity);
                saveBtn.innerHTML = '<i data-lucide="star" class="w-6 h-6 fill-yellow-400 text-yellow-400"></i>';
            }
            localStorage.setItem('favouriteWeatherCities', JSON.stringify(favouriteCities));
            renderFavourites();
            lucide.createIcons();
        });

        // --- Functions ---

        // Fetch Autocomplete Suggestions
        async function fetchAutocomplete(query) {
            try {
                const res = await fetch(`/api/autocomplete?text=${query}`);
                const data = await res.json();
                if (data.features) renderAutocomplete(data.features);
            } catch (err) {
                console.error("Autocomplete error", err);
            }
        }

        function renderAutocomplete(features) {
            autocompleteList.innerHTML = '';
            if (features.length === 0) {
                autocompleteList.classList.add('hidden');
                return;
            }
            
            features.forEach(city => {
                const div = document.createElement('div');
                div.className = "p-3 hover:bg-white/10 cursor-pointer border-b border-white/5 last:border-0 text-sm text-white/80";
                div.innerText = city.properties.formatted;
                div.onclick = () => {
                    searchInput.value = city.properties.city || city.properties.name;
                    fetchWeather(searchInput.value);
                    autocompleteList.classList.add('hidden');
                };
                autocompleteList.appendChild(div);
            });
            autocompleteList.classList.remove('hidden');
        }

        // Fetch Main Weather Data
        async function fetchWeather(city, lat = null, lon = null) {
            showLoading();
            
            let weatherUrl, forecastUrl;
            if (city) {
                weatherUrl = `/api/currentWeather?q=${city}&units=${currentUnit}`;
                forecastUrl = `/api/forecast?q=${city}&units=${currentUnit}`;
            } else {
                weatherUrl = `/api/currentWeather?lat=${lat}&lon=${lon}&units=${currentUnit}`;
                forecastUrl = `/api/forecast?lat=${lat}&lon=${lon}&units=${currentUnit}`;
            }

            try {
                const [weatherRes, forecastRes] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(forecastUrl)
                ]);

                if (!weatherRes.ok) throw new Error("City not found");
                
                const weatherData = await weatherRes.json();
                const forecastData = await forecastRes.json();

                currentCity = weatherData.name;
                updateUI(weatherData, forecastData);
                updateSaveBtnState();
                
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        }

        function updateUI(current, forecast) {
            const u = currentUnit === 'metric';
            const tempSuffix = u ? '°' : '°';
            const speedSuffix = u ? ' km/h' : ' mph';
            const distSuffix = u ? ' km' : ' mi';

            // --- Main Card ---
            document.getElementById('city-name').innerText = current.name;
            document.getElementById('weather-desc').innerText = current.weather[0].description;
            document.getElementById('current-temp').innerText = Math.round(current.main.temp) + tempSuffix;
            document.getElementById('max-min-temp').innerText = `H: ${Math.round(current.main.temp_max)}° L: ${Math.round(current.main.temp_min)}°`;
            document.getElementById('feels-like').innerText = `Feels: ${Math.round(current.main.feels_like)}°`;
            document.getElementById('weather-icon').src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@4x.png`;

            // --- Highlights ---
            const windSpeed = u ? (current.wind.speed * 3.6).toFixed(1) : current.wind.speed.toFixed(1);
            const visibility = u ? (current.visibility / 1000).toFixed(1) : (current.visibility * 0.000621371).toFixed(1);

            document.getElementById('wind-val').innerText = windSpeed;
            document.getElementById('wind-unit').innerText = speedSuffix;
            
            document.getElementById('humidity-val').innerText = current.main.humidity;
            
            document.getElementById('visibility-val').innerText = visibility;
            document.getElementById('dist-unit').innerText = distSuffix;
            
            document.getElementById('pressure-val').innerText = current.main.pressure;

            // Sun Cycle
            const timezoneOffset = current.timezone;
            document.getElementById('sunrise-val').innerText = formatTime(current.sys.sunrise, timezoneOffset);
            document.getElementById('sunset-val').innerText = formatTime(current.sys.sunset, timezoneOffset);

            // --- Hourly Forecast (Next 24h) ---
            const hourlyContainer = document.getElementById('hourly-container');
            hourlyContainer.innerHTML = '';
            
            // Take first 12 entries (approx 36 hours)
            forecast.list.slice(0, 12).forEach(item => {
                const time = formatTime(item.dt, timezoneOffset, true);
                const temp = Math.round(item.main.temp);
                const icon = item.weather[0].icon;
                
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-20 glass-card rounded-2xl p-3 flex flex-col items-center justify-center gap-2";
                div.innerHTML = `
                    <span class="text-xs text-white/70">${time}</span>
                    <img src="https://openweathermap.org/img/wn/${icon}.png" class="w-10 h-10" />
                    <span class="text-lg font-bold">${temp}°</span>
                `;
                hourlyContainer.appendChild(div);
            });

            // --- Daily Forecast ---
            const dailyContainer = document.getElementById('daily-container');
            dailyContainer.innerHTML = '';
            
            // Process Forecast Data to get daily approximations (taking noon value)
            const dailyMap = new Map();
            forecast.list.forEach(item => {
                const date = new Date(item.dt * 1000).toLocaleDateString('en-US', { weekday: 'long' });
                if(!dailyMap.has(date)) {
                    dailyMap.set(date, {
                        tempMax: -100,
                        tempMin: 100,
                        icon: item.weather[0].icon,
                        desc: item.weather[0].description
                    });
                }
                // Update min/max
                const dayData = dailyMap.get(date);
                dayData.tempMax = Math.max(dayData.tempMax, item.main.temp_max);
                dayData.tempMin = Math.min(dayData.tempMin, item.main.temp_min);
                
                // Prefer mid-day icon (approx logic)
                if (item.sys.pod === 'd' && item.weather[0].icon.includes('d')) {
                    dayData.icon = item.weather[0].icon;
                }
            });

            let count = 0;
            dailyMap.forEach((val, key) => {
                if (count >= 5) return; // Limit to 5 days
                count++;
                
                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-3 hover:bg-white/5 rounded-xl transition";
                row.innerHTML = `
                    <span class="w-24 font-medium">${key}</span>
                    <div class="flex items-center gap-2 flex-1">
                        <img src="https://openweathermap.org/img/wn/${val.icon}.png" class="w-8 h-8" />
                        <span class="text-xs text-white/50 hidden sm:block capitalize">${val.desc}</span>
                    </div>
                    <div class="flex gap-4 text-right">
                        <span class="font-bold">${Math.round(val.tempMax)}°</span>
                        <span class="text-white/40">${Math.round(val.tempMin)}°</span>
                    </div>
                `;
                dailyContainer.appendChild(row);
            });

            weatherDashboard.classList.remove('hidden');
            errorContainer.classList.add('hidden');
        }

        // --- Helper Functions ---
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            weatherDashboard.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showError(msg) {
            hideLoading();
            weatherDashboard.classList.add('hidden');
            errorContainer.innerText = msg;
            errorContainer.classList.remove('hidden');
        }

        function formatTime(unix, offset, short = false) {
            const date = new Date((unix + offset) * 1000);
            // Fix timezone offset simply by using UTC methods manually adjusted or standard toLocaleString with timeZone option if available. 
            // Simplified approach for this demo:
            const hours = date.getUTCHours(); 
            const minutes = date.getUTCMinutes();
            
            // Manual simple formatting to avoid complex TZ logic in vanilla JS without libraries
            // Note: The offset from API is in seconds.
            // Correct way in Vanilla JS using the offset:
            const localDate = new Date(date.getTime() + (new Date().getTimezoneOffset() * 60000)); // Convert to UTC first roughly if needed, but standard way:
            
            // Let's use a simpler display that ignores browser timezone and uses the raw time relative to UTC + offset
            // We create a date object that "looks" like the local time
            const displayDate = new Date(unix * 1000 + (offset * 1000)); 
            
            let h = displayDate.getUTCHours();
            const m = displayDate.getUTCMinutes();
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; 
            const mStr = m < 10 ? '0'+m : m;
            
            return short ? `${h} ${ampm}` : `${h}:${mStr} ${ampm}`;
        }

        function renderFavourites() {
            const container = document.getElementById('favourites-container');
            container.innerHTML = '';
            if (favouriteCities.length === 0) {
                container.innerHTML = '<span class="text-white/20 text-sm italic px-1">No saved cities</span>';
                return;
            }
            favouriteCities.forEach(city => {
                const chip = document.createElement('button');
                chip.className = "px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 border border-white/5 text-xs transition";
                chip.innerText = city;
                chip.onclick = () => fetchWeather(city);
                container.appendChild(chip);
            });
        }

        function updateSaveBtnState() {
            if (favouriteCities.includes(currentCity)) {
                saveBtn.innerHTML = '<i data-lucide="star" class="w-6 h-6 fill-yellow-400 text-yellow-400"></i>';
            } else {
                saveBtn.innerHTML = '<i data-lucide="star" class="w-6 h-6"></i>';
            }
            lucide.createIcons();
        }

    </script>
</body>
</html>